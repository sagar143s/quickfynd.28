// Homepage grid section config (persistent)
model GridSection {
  id         Int      @id @default(autoincrement())
  index      Int      // 0, 1, 2 for up to 3 sections
  title      String
  path       String
  productIds String[]
  updatedAt  DateTime @updatedAt
}
generator client {
  provider   = "prisma-client-js"
  engineType = "library"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Required for creating a User: id, name, email, image, cart (optional JSON string)
model User {
  id    String @id
  name  String
  email String
  image String
  cart  Json   @default("{}")

  // Relations
  ratings            Rating[]
  Address            Address[]
  store              Store?
  buyerOrders        Order[]         @relation("BuyerRelation")
  wishlistItems      WishlistItem[]
  abandonedCarts     AbandonedCart[]
  returnRequests     ReturnRequest[]
  storeUsers         StoreUser[]
  invitedStoreUsers  StoreUser[]     @relation("InvitedBy")
  approvedStoreUsers StoreUser[]     @relation("ApprovedBy")
}

// Guest user details before account creation
model GuestUser {
  id             String    @id @default(cuid())
  name           String
  email          String    @unique
  phone          String
  accountCreated Boolean   @default(false)
  convertToken   String?   @unique
  tokenExpiry    DateTime?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
}

// Required for creating a Product: name, description, mrp, price, images, category, storeId
model Product {
  id               String   @id @default(cuid())
  name             String
  slug             String   @unique
  description      String
  shortDescription String?
  mrp              Float
  price            Float
  images           String[]
  category         String
  sku              String?
  inStock          Boolean  @default(true)
  // Variants support
  hasVariants      Boolean  @default(false)
  variants         Json     @default("[]")
  attributes       Json     @default("{}")
  // Bulk pricing support
  hasBulkPricing   Boolean  @default(false)
  bulkPricing      Json     @default("[]")
  fastDelivery     Boolean  @default(false)
  allowReturn      Boolean  @default(true)
  allowReplacement Boolean  @default(true)
  storeId          String
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  // Relations
  store         Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  orderItems    OrderItem[]
  rating        Rating[]
  wishlistItems WishlistItem[]
}

enum OrderStatus {
  ORDER_PLACED
  PROCESSING
  SHIPPED
  DELIVERED
}

enum PaymentMethod {
  COD
  STRIPE
}

// Required for creating an Order: total, userId, storeId, addressId, isPaid, paymentMethod, isCouponUsed, coupon (JSON), orderItems (nested)
model Order {
  id            String        @id @default(cuid())
  total         Float
  status        OrderStatus   @default(ORDER_PLACED)
  userId        String?
  storeId       String
  addressId     String?
  isPaid        Boolean       @default(false)
  paymentMethod PaymentMethod
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  isCouponUsed  Boolean       @default(false)
  coupon        Json          @default("{}")
  trackingId    String?
  trackingUrl   String?
  courier       String?
  isGuest       Boolean       @default(false)
  guestName     String?
  guestEmail    String?
  guestPhone    String?
  orderItems    OrderItem[]
  ratings       Rating[]

  // Relations
  user    User?   @relation("BuyerRelation", fields: [userId], references: [id])
  store   Store   @relation(fields: [storeId], references: [id])
  address Address? @relation(fields: [addressId], references: [id])
}

// Required for creating an OrderItem: orderId, productId, quantity, price
model OrderItem {
  orderId   String
  productId String
  quantity  Int
  price     Float

  // Relations
  order   Order   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id])

  @@id([orderId, productId])
}

// Required for creating a Rating: rating, review, userId, productId
model Rating {
  id        String   @id @default(cuid())
  rating    Int
  review    String
  images    String[] @default([])
  approved  Boolean  @default(false)
  userId    String
  productId String
  orderId   String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  order   Order?  @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

// Wishlist entries per user per product
model WishlistItem {
  id        String   @id @default(cuid())
  userId    String
  productId String
  createdAt DateTime @default(now())

  user    User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  product Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  @@unique([userId, productId])
}

// Return and Replacement Requests
model ReturnRequest {
  id             String   @id @default(cuid())
  orderId        String
  userId         String?
  storeId        String
  type           String // "RETURN" or "REPLACEMENT"
  reason         String
  description    String?
  images         String[] @default([])
  videos         String[] @default([])
  status         String   @default("PENDING") // PENDING, APPROVED, REJECTED, COMPLETED
  fastProcess    Boolean  @default(false)
  // Optional customer feedback captured during return/replacement request
  productRating  Int?
  deliveryRating Int?
  reviewText     String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  // Relations
  user  User? @relation(fields: [userId], references: [id])
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// Category model with parent-child relationships
model Category {
  id          String   @id @default(cuid())
  name        String
  slug        String   @unique
  description String?
  image       String?
  parentId    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // Relations
  parent   Category?  @relation("CategoryToCategory", fields: [parentId], references: [id], onDelete: Cascade)
  children Category[] @relation("CategoryToCategory")
}

// Required for creating an Address: userId, name, email, street, city, state, zip, country, phone
model Address {
  id        String   @id @default(cuid())
  userId    String
  name      String
  email     String
  street    String
  city      String
  state     String
  zip       String? // Made optional as not all countries require zip codes
  country   String
  phone     String
  phoneCode String   @default("+971") // Country phone code
  createdAt DateTime @default(now())

  // Relations
  Order Order[]
  user  User    @relation(fields: [userId], references: [id], onDelete: Cascade)
}

// Required for creating a Coupon: code, description, discount, forNewUser, isPublic, expiresAt
model Coupon {
  code             String   @id
  description      String
  discount         Float
  discountType     String   @default("percentage") // "percentage" or "fixed"
  minPrice         Float    @default(0) // Minimum cart value to apply coupon
  minProductCount  Int? // Minimum number of products
  specificProducts String[] @default([]) // Array of product IDs this coupon applies to
  forNewUser       Boolean  @default(false)
  forMember        Boolean  @default(false)
  firstOrderOnly   Boolean  @default(false) // Only for customer's first order
  oneTimePerUser   Boolean  @default(false) // Each user can use only once
  usageLimit       Int? // Total usage limit across all users
  usedCount        Int      @default(0) // Track how many times used
  isPublic         Boolean
  isActive         Boolean  @default(true)
  storeId          String? // If store-specific, null for admin coupons
  expiresAt        DateTime
  createdAt        DateTime @default(now())

  // Relations
  store Store? @relation(fields: [storeId], references: [id], onDelete: Cascade)
}

// Required for creating a Store: userId, name, username, email, contact, logo, description, address (optional: , status, isActive)
model Store {
  id          String   @id @default(cuid())
  userId      String   @unique
  name        String
  description String
  username    String   @unique
  address     String
  status      String   @default("pending")
  isActive    Boolean  @default(false)
  logo        String
  email       String
  contact     String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  Product       Product[]
  Order         Order[]
  Coupon        Coupon[]
  AbandonedCart AbandonedCart[]
  ReturnRequest ReturnRequest[]
  user          User            @relation(fields: [userId], references: [id])
  storeUsers    StoreUser[]
}

// Admin-curated selections for homepage sections
model HomeSelection {
  id            String   @id @default(cuid())
  section       String // e.g., 'limited_offers', 'best_selling', 'home_deals'
  category      String? // optional category filter/label
  tag           String? // optional tag label
  productIds    String[] // ordered selection of product ids
  // New fields for dashboard-controlled homepage sections
  title         String   @default("Untitled Section")
  subtitle      String?
  slides        String[] @default([]) // image URLs for banner/slider usage
  // Rich per-slide configuration (image, title, subtitle, CTA, colors, alignment)
  slidesData    Json     @default("[]")
  bannerCtaText String? // optional CTA text for banner
  bannerCtaLink String? // optional CTA link for banner
  layout        String   @default("deals_with_banner") // future-proofing different layouts
  isActive      Boolean  @default(true)
  sortOrder     Int      @default(0)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
}

// Abandoned cart tracking
model AbandonedCart {
  id          String   @id @default(cuid())
  userId      String
  storeId     String
  items       Json // Cart items with product details
  total       Float
  lastUpdated DateTime @default(now()) @updatedAt
  createdAt   DateTime @default(now())

  user  User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([userId, storeId])
}

// Platform-level shipping settings (singleton via id='default')
enum ShippingType {
  FLAT_RATE
  PER_ITEM
  WEIGHT_BASED
  FREE
}

model ShippingSetting {
  id      String  @id @default("default")
  enabled Boolean @default(true)

  // Shipping Type
  shippingType ShippingType @default(FLAT_RATE)

  // Flat Rate Settings
  flatRate Float @default(5)

  // Per Item Settings
  perItemFee Float  @default(2)
  maxItemFee Float? // Optional cap on total per-item fees

  // Weight Based Settings
  weightUnit          String @default("kg") // "kg" or "lb"
  baseWeight          Float  @default(1) // Base weight in chosen unit
  baseWeightFee       Float  @default(5) // Fee for base weight
  additionalWeightFee Float  @default(2) // Fee per additional unit

  // Free Shipping Threshold
  freeShippingMin Float @default(499)

  // Regional/Distance Settings
  localDeliveryFee    Float? // Optional local delivery flat fee
  regionalDeliveryFee Float? // Optional regional delivery fee

  // Delivery Time Estimates
  estimatedDays String @default("3-5") // e.g., "3-5", "1-2", "5-7"

  // Additional Options
  enableCOD Boolean @default(true)
  codFee    Float   @default(0) // Extra fee for COD

  // Express/Priority Shipping
  enableExpressShipping Boolean @default(false)
  expressShippingFee    Float   @default(20)
  expressEstimatedDays  String  @default("1-2")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// StoreUser: Manages store user invitations, roles, and approval
model StoreUser {
  id           String    @id @default(cuid())
  storeId      String
  userId       String? // Null until invite is accepted/linked
  email        String
  role         String    @default("member") // 'admin', 'member', etc.
  status       String    @default("invited") // 'invited', 'pending', 'approved', 'rejected', 'removed'
  invitedById  String? // User who sent the invite
  approvedById String? // User who approved
  inviteToken  String?   @unique
  inviteExpiry DateTime?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  store      Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  user       User? @relation(fields: [userId], references: [id])
  invitedBy  User? @relation("InvitedBy", fields: [invitedById], references: [id])
  approvedBy User? @relation("ApprovedBy", fields: [approvedById], references: [id])

  @@unique([storeId, email])
}
